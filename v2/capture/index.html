<!DOCTYPE html>
<html lang="en">

<head>
    <title>Presen√ßa</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <h1>Webcam Capture</h1>

    <div class="row">
        <div class="form-group col-2 p-2">
            <label for="idempresa">Empresa</label>
            <input type="text" class="form-control" id="idempresa">
        </div>

        <div class="form-group col-2 p-2">
            <label for="idpessoa">Pessoa</label>
            <input type="text" class="form-control" id="idpessoa">
        </div>
    </div>

    <div class="row">
        <button id="startButton" class="col-4" onclick="startWebcam()">Start Webcam</button>
        <button id="captureButton" class="col-4" onclick="capturePhoto()" disabled>Capture Photo</button>
        <button id="sendPhotos" class="col-4" onclick="sendPhotos()" disabled>Send Photos</button>
    </div>

    <div class="row">
        <video id="videoElement" class="col-lg-4 col-12" autoplay></video>
    </div>


    <div id="div-canvas" class="d-flex flex-row flex-wrap">
    </div>

    <div id="text" class="row">
        <textarea id="inputs" name="w3review" rows="4" cols="50"></textarea>
    </div>


    <!-- JavaScript code will go here -->
    <script>
        const videoElement = document.getElementById('videoElement');
        const startButton = document.getElementById('startButton');
        const captureButton = document.getElementById('captureButton');

        let stream;

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
                startButton.disabled = true;
                captureButton.disabled = false;
            } catch (error) {
                console.error('Error accessing webcam:', error);
            }
        }

        function capturePhoto() {
            const parser = new DOMParser();

            qtdElements = document.getElementsByClassName('canvas')
            count = qtdElements.length + 1
            html = '<canvas id="canvasElement-' + count + '" class="canvas" style="display: none;"></canvas>'
            html += '<img id="photoElement-' + count + '" style="display: none;" class="img-fluid photo">'
            document.getElementById('div-canvas').append(stringToHTML(html))

            const canvasElement = document.getElementById('canvasElement-' + count)
            const photoElement = document.getElementById('photoElement-' + count)
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            canvasElement.getContext('2d').drawImage(videoElement, 0, 0);
            const photoDataUrl = canvasElement.toDataURL('image/jpeg');
            photoElement.src = photoDataUrl;
            photoElement.style.display = 'block';
            document.getElementById('sendPhotos').disabled = false;
        }

        var stringToHTML = function (str) {
            var dom = document.createElement('div');
            dom.classList.add('col-lg-1');
            dom.classList.add('col-md-4');
            dom.classList.add('p-1');
            dom.innerHTML = str;
            return dom;
        };

        // Execute a function when the user presses a key on the keyboard
        idempresa.addEventListener("keypress", function (event) {
            // If the user presses the "Enter" key on the keyboard
            if (event.key === "Enter") {
                // Cancel the default action, if needed
                event.preventDefault();
                if (inputs.value.indexOf(idempresa.value) == -1) {
                    inputs.value = inputs.value + idempresa.value + ';'
                }
                idempresa.value = null
                idempresa.focus()
            }
        });

        async function sendPhotos() {
            elements = document.getElementsByClassName('photo')

            json = {
                imagens: []
            }

            for (i = 0; i < elements.length; i++) {
                json.imagens.push(elements[i].src.split(',')[1])
            }


            url = 'http://localhost:8000/api/v1/imagens/' + document.getElementById('idempresa').value + '/' + document.getElementById('idpessoa').value


            const raw = JSON.stringify(json)

            response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: raw
            })
                .then(resp => resp.json())
                .then(data => {
                    alert('Cadastro salvo com sucesso!')
                    document.getElementById('div-canvas').innerHTML = null
                    document.getElementById('idpessoa').value = null
                    document.getElementById('idpessoa').focus()
                    document.getElementById('sendPhotos').disabled = true;
                })
                .catch(error => {
                    console.log(error)
                })
        }
    </script>

</body>

</html>